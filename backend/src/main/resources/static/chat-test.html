<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat Test</title>
  <!-- SockJS와 Stomp.js 라이브러리 CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chat {
      width: 400px;
      height: 300px;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: scroll;
      margin-bottom: 10px;
    }
    #messageInput {
      width: 300px;
    }
  </style>
</head>
<body>
<h2>WebSocket Chat Test</h2>
<!-- 채팅방 번호 입력 및 연결/해제 버튼 -->
<div>
  <label for="roomId">Room ID:</label>
  <input type="text" id="roomId" value="1" />
  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button>
</div>
<!-- 채팅 메시지를 표시할 영역 -->
<div id="chat"></div>
<!-- 메시지 입력 및 전송 버튼 -->
<div>
  <input type="text" id="messageInput" placeholder="Type your message here..." />
  <button onclick="sendMessage()">Send</button>
</div>
<script>
  var stompClient = null;
  var subscription = null;

  // WebSocket 연결 함수
  function connect() {
    var roomId = document.getElementById("roomId").value;
    // /ws 엔드포인트로 SockJS 연결 생성
    var socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      // 연결 후 구독할 경로 설정
      // 구독 경로는 WebSocketConfig에서 설정한 "/sub" 프리픽스를 사용하여 구성합니다.
      subscription = stompClient.subscribe('/sub/chat/room/' + roomId, function(messageOutput) {
        showMessage(JSON.parse(messageOutput.body));
      });
    });
  }

  // WebSocket 연결 해제 함수
  function disconnect() {
    if (stompClient !== null) {
      stompClient.disconnect();
    }
    console.log("Disconnected");
  }

  // 메시지 전송 함수
  function sendMessage() {
    var roomId = document.getElementById("roomId").value;
    var message = document.getElementById("messageInput").value;
    // 채팅 메시지 요청 객체 생성
    var chatMessageRequest = {
      chatroomId: roomId,
      content: message
    };
    // /pub 프리픽스를 사용하여 메시지 발행
    // 컨트롤러의 @MessageMapping("/{roomId}/message")에 매핑됩니다.
    stompClient.send("/pub/" + roomId + "/message", {}, JSON.stringify(chatMessageRequest));
  }

  // 수신한 메시지를 화면에 표시하는 함수
  function showMessage(message) {
    var chat = document.getElementById("chat");
    var messageElement = document.createElement("div");
    messageElement.innerText = message.content;
    chat.appendChild(messageElement);
  }
</script>
</body>
</html>
